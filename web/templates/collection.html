{{define "collection_content"}}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>{{.collection}} - 文档列表
                    </h5>
                    <div>
                        <a href="/database/{{.dbName}}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left me-1"></i>返回
                        </a>
                        <button class="btn btn-primary" onclick="createDocument()">
                            <i class="fas fa-plus me-1"></i>添加文档
                        </button>
                        <button class="btn btn-info" onclick="showQueryModal()">
                            <i class="fas fa-search me-1"></i>查询
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">每页显示</span>
                            <select class="form-select" id="pageSize" onchange="changePageSize()">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="input-group-text">条</span>
                        </div>
                    </div>
                    <div class="col-md-8 text-end">
                        <span class="text-muted">共 {{.total}} 条记录，第 {{.page}} 页</span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="200px">_id</th>
                                <th>文档内容</th>
                                <th width="150px">操作</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable">
                            {{range .documents}}
                            <tr>
                                <td>
                                    <code class="text-primary">{{._id}}</code>
                                </td>
                                <td>
                                    <pre class="mb-0"><code>{{.}}</code></pre>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editDocument('{{._id}}')">
                                            <i class="fas fa-edit"></i> 编辑
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteDocument('{{._id}}')">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>暂无文档</p>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>

                <!-- 翻页导航 -->
                {{if gt .total 0}}
                <div class="row mt-3">
                    <div class="col-md-6">
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0">
                                {{if gt .page 1}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{sub .page 1}}&limit={{.limit}}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {{end}}

                                {{$currentPage := .page}}
                                {{$totalPages := .totalPages}}
                                {{range .pageNumbers}}
                                {{if eq . $currentPage}}
                                <li class="page-item active">
                                    <span class="page-link">{{.}}</span>
                                </li>
                                {{else}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{.}}&limit={{$.limit}}">{{.}}</a>
                                </li>
                                {{end}}
                                {{end}}

                                {{if lt .page .totalPages}}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{add .page 1}}&limit={{.limit}}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                {{end}}
                            </ul>
                        </nav>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="text-muted">
                            显示第 {{.start}} - {{.end}} 条，共 {{.total}} 条记录
                        </span>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑文档模态框 -->
<div class="modal fade" id="documentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalTitle">
                    <i class="fas fa-plus me-2"></i>添加文档
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jsonEditor" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveDocument()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查询模态框 -->
<div class="modal fade" id="queryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>查询文档
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="queryEditor" style="height: 200px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeQuery()">查询</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "collection_scripts"}}
<script>
const dbName = '{{.dbName}}';
const collectionName = '{{.collection}}';
let currentEditingId = null;
let jsonEditor = null;
let queryEditor = null;

document.addEventListener('DOMContentLoaded', function() {
    // 不再使用JSONEditor，改为简单的textarea
    console.log('集合页面加载完成');
});

function createDocument() {
    currentEditingId = null;
    document.getElementById('documentModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>添加文档';

    // 显示空的JSON模板
    const jsonContainer = document.getElementById('jsonEditor');
    jsonContainer.innerHTML = `<textarea style="width: 100%; height: 400px; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; font-family: monospace;">{
    "key": "value"
}</textarea>`;

    new bootstrap.Modal(document.getElementById('documentModal')).show();
}

function editDocument(id) {
    currentEditingId = id;
    document.getElementById('documentModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>编辑文档';

    // 获取文档数据
    fetch(`/api/v1/db/${dbName}/collections/${collectionName}/documents/${id}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            // 显示可编辑的JSON格式化数据
            const jsonContainer = document.getElementById('jsonEditor');
            jsonContainer.innerHTML = `<textarea style="width: 100%; height: 400px; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; font-family: monospace;">${JSON.stringify(data, null, 2)}</textarea>`;

            new bootstrap.Modal(document.getElementById('documentModal')).show();
        }
    })
    .catch(error => showError(error.message));
}

function saveDocument() {
    try {
        // 从textarea获取JSON数据
        const jsonContainer = document.getElementById('jsonEditor');
        const textarea = jsonContainer.querySelector('textarea');
        const document = JSON.parse(textarea.value);

        const url = currentEditingId
            ? `/api/v1/db/${dbName}/collections/${collectionName}/documents/${currentEditingId}`
            : `/api/v1/db/${dbName}/collections/${collectionName}/documents`;

        const method = currentEditingId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(document)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showSuccess(currentEditingId ? '文档更新成功' : '文档创建成功');
                bootstrap.Modal.getInstance(document.getElementById('documentModal')).hide();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => showError(error.message));
    } catch (error) {
        showError('JSON格式错误: ' + error.message);
    }
}

function deleteDocument(id) {
    if (!confirm('确定要删除这个文档吗？此操作不可恢复！')) {
        return;
    }

    fetch(`/api/v1/db/${dbName}/collections/${collectionName}/documents/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            showSuccess('文档删除成功');
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => showError(error.message));
}

function showQueryModal() {
    // 显示查询输入框
    const queryContainer = document.getElementById('queryEditor');
    queryContainer.innerHTML = `<textarea style="width: 100%; height: 200px; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; font-family: monospace;" placeholder="输入查询条件，例如：
{
  \"name\": \"张三\",
  \"age\": { \"$gte\": 18 }
}">{}</textarea>`;

    new bootstrap.Modal(document.getElementById('queryModal')).show();
}

function executeQuery() {
    try {
        // 从textarea获取查询条件
        const queryContainer = document.getElementById('queryEditor');
        const textarea = queryContainer.querySelector('textarea');
        const queryText = textarea.value.trim() || '{}';
        const query = JSON.parse(queryText);

        fetch(`/api/v1/db/${dbName}/collections/${collectionName}/query`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: query,
                page: 1,
                limit: 20
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                // 更新表格内容
                updateDocumentsTable(data.documents);
                showSuccess(`查询完成，找到 ${data.total} 条记录`);
                bootstrap.Modal.getInstance(document.getElementById('queryModal')).hide();
            }
        })
        .catch(error => showError(error.message));
    } catch (error) {
        showError('JSON格式错误: ' + error.message);
    }
}

function updateDocumentsTable(documents) {
    const tbody = document.getElementById('documentsTable');
    tbody.innerHTML = '';

    if (documents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>没有找到匹配的文档</p></td></tr>';
        return;
    }

    documents.forEach(doc => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><code class="text-primary">${doc._id}</code></td>
            <td><pre class="mb-0"><code>${JSON.stringify(doc, null, 2)}</code></pre></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editDocument('${doc._id}')">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDocument('${doc._id}')">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function changePageSize() {
    const pageSize = document.getElementById('pageSize').value;
    window.location.href = `?page=1&limit=${pageSize}`;
}
</script>
{{end}}