<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>连接管理 - MongoDB管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database me-2"></i>MongoDB管理工具
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i>首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/connections">
                            <i class="fas fa-plug me-1"></i>连接管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showStats()">
                            <i class="fas fa-chart-bar me-1"></i>统计信息
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-plug me-2"></i>连接管理
                        </h5>
                        <div>
                            <a href="/" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-home me-1"></i>返回首页
                            </a>
                            <button class="btn btn-primary" onclick="showAddConnectionModal()">
                                <i class="fas fa-plus me-1"></i>添加连接
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    当前连接：<strong>{{range .connections}}{{if eq .ID $.currentId}}{{.Name}} ({{.Host}}:{{.Port}}){{end}}{{end}}</strong>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>名称</th>
                                        <th>地址</th>
                                        <th>数据库</th>
                                        <th>用户名</th>
                                        <th>描述</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .connections}}
                                    <tr>
                                        <td>
                                            <strong>{{.Name}}</strong>
                                            {{if eq .ID $.currentId}}
                                            <span class="badge bg-success ms-2">当前</span>
                                            {{end}}
                                        </td>
                                        <td>
                                            <code>{{.Host}}:{{.Port}}</code>
                                        </td>
                                        <td>{{.Database}}</td>
                                        <td>{{.Username}}</td>
                                        <td>{{.Description}}</td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-circle text-success me-1"></i>未测试
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {{if ne .ID $.currentId}}
                                                <button class="btn btn-outline-primary" onclick="setCurrentConnection('{{.ID}}')">
                                                    <i class="fas fa-check"></i> 设为当前
                                                </button>
                                                {{end}}
                                                <button class="btn btn-outline-info" onclick="testConnection('{{.ID}}')">
                                                    <i class="fas fa-plug"></i> 测试
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="editConnection('{{.ID}}')">
                                                    <i class="fas fa-edit"></i> 编辑
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteConnection('{{.ID}}')">
                                                    <i class="fas fa-trash"></i> 删除
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {{else}}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-plug fa-3x mb-3"></i>
                                            <p>暂无连接配置</p>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑连接模态框 -->
    <div class="modal fade" id="connectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectionModalTitle">
                        <i class="fas fa-plus me-2"></i>添加连接
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="connectionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionName" class="form-label">连接名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="connectionName" required>
                                    <div class="form-text">连接的友好名称，用于识别</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionHost" class="form-label">主机地址 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="connectionHost" required placeholder="localhost">
                                    <div class="form-text">MongoDB服务器地址</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="connectionPort" class="form-label">端口 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="connectionPort" value="27017" required>
                                    <div class="form-text">MongoDB服务端口</div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="connectionDatabase" class="form-label">数据库</label>
                                    <input type="text" class="form-control" id="connectionDatabase" placeholder="admin">
                                    <div class="form-text">默认数据库，留空则使用admin</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionUsername" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="connectionUsername">
                                    <div class="form-text">MongoDB认证用户名</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionPassword" class="form-label">密码</label>
                                    <input type="password" class="form-control" id="connectionPassword">
                                    <div class="form-text">MongoDB认证密码</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionAuthDB" class="form-label">认证数据库</label>
                                    <input type="text" class="form-control" id="connectionAuthDB" placeholder="admin">
                                    <div class="form-text">用户认证数据库，默认为admin</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connectionDescription" class="form-label">描述</label>
                                    <input type="text" class="form-control" id="connectionDescription">
                                    <div class="form-text">连接的简要描述</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="testConnectionBeforeSave()">测试连接</button>
                    <button type="button" class="btn btn-success" onclick="saveConnection()">保存连接</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错误模态框 -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>错误
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功提示 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">成功</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
    let currentEditingId = null;

    function showAddConnectionModal() {
        currentEditingId = null;
        document.getElementById('connectionModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>添加连接';
        document.getElementById('connectionForm').reset();
        document.getElementById('connectionPort').value = '27017';
        new bootstrap.Modal(document.getElementById('connectionModal')).show();
    }

    function editConnection(id) {
        currentEditingId = id;
        document.getElementById('connectionModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>编辑连接';

        // 获取连接信息
        fetch(`/api/v1/connections/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                // 填充表单
                document.getElementById('connectionName').value = data.name;
                document.getElementById('connectionHost').value = data.host;
                document.getElementById('connectionPort').value = data.port;
                document.getElementById('connectionDatabase').value = data.database;
                document.getElementById('connectionUsername').value = data.username || '';
                document.getElementById('connectionPassword').value = data.password || '';
                document.getElementById('connectionAuthDB').value = data.authDB || '';
                document.getElementById('connectionDescription').value = data.description || '';

                new bootstrap.Modal(document.getElementById('connectionModal')).show();
            }
        })
        .catch(error => showError(error.message));
    }

    function testConnection(id) {
        fetch(`/api/v1/connections/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }

            // 测试连接
            return fetch('/api/v1/connections/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError('连接测试失败: ' + data.error);
            } else {
                showSuccess('连接测试成功！');
            }
        })
        .catch(error => showError(error.message));
    }

    function testConnectionBeforeSave() {
        const config = getFormConfig();

        fetch('/api/v1/connections/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError('连接测试失败: ' + data.error);
            } else {
                showSuccess('连接测试成功！');
            }
        })
        .catch(error => showError(error.message));
    }

    function saveConnection() {
        const config = getFormConfig();

        if (!config.name || !config.host) {
            showError('请填写连接名称和主机地址');
            return;
        }

        const url = currentEditingId
            ? `/api/v1/connections/${currentEditingId}`
            : '/api/v1/connections';

        const method = currentEditingId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showSuccess(currentEditingId ? '连接更新成功' : '连接添加成功');
                bootstrap.Modal.getInstance(document.getElementById('connectionModal')).hide();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => showError(error.message));
    }

    function setCurrentConnection(id) {
        fetch(`/api/v1/connections/${id}/current`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showSuccess('当前连接设置成功');
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => showError(error.message));
    }

    function deleteConnection(id) {
        if (!confirm('确定要删除这个连接吗？')) {
            return;
        }

        fetch(`/api/v1/connections/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showSuccess('连接删除成功');
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => showError(error.message));
    }

    function getFormConfig() {
        return {
            name: document.getElementById('connectionName').value,
            host: document.getElementById('connectionHost').value,
            port: parseInt(document.getElementById('connectionPort').value),
            database: document.getElementById('connectionDatabase').value,
            username: document.getElementById('connectionUsername').value,
            password: document.getElementById('connectionPassword').value,
            authDB: document.getElementById('connectionAuthDB').value,
            description: document.getElementById('connectionDescription').value
        };
    }
    </script>
</body>
</html>