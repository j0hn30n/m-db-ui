name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  GO_VERSION: '1.21'

jobs:
  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Windows
          - os: windows
            arch: amd64
            runner: windows-latest
            binary_name: m-db-ui.exe
            artifact_name: m-db-ui-windows-amd64.exe
          - os: windows
            arch: arm64
            runner: windows-latest
            binary_name: m-db-ui.exe
            artifact_name: m-db-ui-windows-arm64.exe

          # Linux
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            binary_name: m-db-ui
            artifact_name: m-db-ui-linux-amd64
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            binary_name: m-db-ui
            artifact_name: m-db-ui-linux-arm64
          - os: linux
            arch: 386
            runner: ubuntu-latest
            binary_name: m-db-ui
            artifact_name: m-db-ui-linux-386

          # macOS
          - os: darwin
            arch: amd64
            runner: macos-latest
            binary_name: m-db-ui
            artifact_name: m-db-ui-darwin-amd64
          - os: darwin
            arch: arm64
            runner: macos-latest
            binary_name: m-db-ui
            artifact_name: m-db-ui-darwin-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Build binary
      shell: bash
      run: |
        mkdir -p dist

        # Set GOOS and GOARCH for cross-compilation
        export GOOS=${{ matrix.os }}
        export GOARCH=${{ matrix.arch }}
        export CGO_ENABLED=0

        # Add version info
        VERSION=${GITHUB_REF#refs/tags/}
        if [[ $VERSION == "" ]]; then
          VERSION="dev"
        fi

        # Build with ldflags for version info
        go build -ldflags "-X main.version=$VERSION -s -w" \
          -o dist/${{ matrix.binary_name }} \
          main.go

    - name: Create archive (Unix)
      if: matrix.os != 'windows'
      run: |
        cd dist
        tar -czf ../${{ matrix.artifact_name }}.tar.gz ${{ matrix.binary_name }}
        cd ..

    - name: Create archive (Windows)
      if: matrix.os == 'windows'
      run: |
        cd dist
        7z a ../${{ matrix.artifact_name }}.zip ${{ matrix.binary_name }}
        cd ..

    - name: Upload artifact (Unix)
      if: matrix.os != 'windows'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}.tar.gz

    - name: Upload artifact (Windows)
      if: matrix.os == 'windows'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}.zip

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: MongoDB Management Tool ${{ github.ref_name }}
        body: |
          ## MongoDBç®¡ç†å·¥å…· v${{ github.ref_name }}

          ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„MongoDB Webç®¡ç†å·¥å…·ï¼Œæ”¯æŒå¤šè¿æ¥ç®¡ç†ã€æ•°æ®åº“æ“ä½œã€é›†åˆç®¡ç†å’Œæ–‡æ¡£ç¼–è¾‘ã€‚

          ### åŠŸèƒ½ç‰¹æ€§ï¼š
          - ğŸŒ Webç•Œé¢ç®¡ç†MongoDB
          - ğŸ”— å¤šè¿æ¥ç®¡ç†å’Œåˆ‡æ¢
          - ğŸ“Š æ•°æ®åº“ã€é›†åˆã€æ–‡æ¡£çš„CRUDæ“ä½œ
          - ğŸ” æ–‡æ¡£æŸ¥è¯¢åŠŸèƒ½
          - ğŸ“ JSONæ–‡æ¡£ç¼–è¾‘
          - ğŸŒ è·¨å¹³å°æ”¯æŒ
          - âš¡ é™æ€èµ„æºæœ¬åœ°åŒ–ï¼Œæ— éœ€ç½‘ç»œä¾èµ–

          ### ä½¿ç”¨æ–¹æ³•ï¼š
          ```bash
          # ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨ï¼ˆ127.0.0.1:8082ï¼‰
          ./m-db-ui

          # æŒ‡å®šä¸»æœºå’Œç«¯å£å¯åŠ¨
          ./m-db-ui -host 0.0.0.0 -port 8080

          # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
          ./m-db-ui --help
          ```

          ### ç³»ç»Ÿè¦æ±‚ï¼š
          - MongoDBæœåŠ¡å™¨è¿æ¥
          - ç°ä»£Webæµè§ˆå™¨

          ### ä¸‹è½½è¯´æ˜ï¼š
          - **Windows**: ä¸‹è½½ `m-db-ui-windows-*.exe` æ–‡ä»¶
          - **Linux**: ä¸‹è½½ `m-db-ui-linux-*` æ–‡ä»¶å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          - **macOS**: ä¸‹è½½ `m-db-ui-darwin-*` æ–‡ä»¶

          ğŸ”— [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }})
        files: |
          artifacts/*/*.tar.gz
          artifacts/*/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ github.repository }}
        tags: |
          type=ref,event=tag
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max